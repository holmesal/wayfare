(function(){"use strict";angular.module("tilemapApp",["ngCookies","ngResource","ngSanitize","ngRoute","firebase"]).config(["$routeProvider",function(a){return a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/generate",{templateUrl:"views/generate.html",controller:"GenerateCtrl"}).when("/view",{templateUrl:"views/view.html",controller:"ViewCtrl"}).when("/walk",{templateUrl:"views/walk.html",controller:"WalkCtrl"}).otherwise({redirectTo:"/"})}])}).call(this),function(){"use strict";angular.module("tilemapApp").controller("MainCtrl",["$scope","$resource","angularFire",function(){return console.log("main controller loaded")}])}.call(this),function(){"use strict";angular.module("tilemapApp").directive("tiler",["$timeout",function(){return{template:'<canvas id="myCanvas" style="width:{{canvas.width}}px;height:{{canvas.height}}px;"></canvas>',restrict:"E",scope:{draw:"=",updateworld:"="},link:function(a,b){var c,d,e;return a.size=12,a.$watch("draw",function(){var c;return console.log(a.draw),a.draw.nodes?(a.size=a.draw.dims.x,c=b.find("canvas")[0],c.width=a.draw.dims.x,c.height=a.draw.dims.y,a.ctx=c.getContext("2d"),a.ctx.strokeStyle="#FF0000",a.ctx.lineWidth=1,d()):void 0}),d=function(){var b,d,f,g;for(d=[],b=f=0,g=a.draw.dims.x*a.draw.dims.y;g>=0?g>f:f>g;b=g>=0?++f:--f)d[b]={id:b,type:0};return a.tiles=d,console.log(a.tiles.length),c(),e()},c=function(){var b,c,d,e,f,g,h,i,j,k,l;for(j=a.draw.roads,l=[],f=0,h=j.length;h>f;f++){for(e=j[f],a.ctx.beginPath(),k=e.nodes,b=g=0,i=k.length;i>g;b=++g)d=k[b],c=a.draw.nodes[d],0===b?a.ctx.moveTo(c.x*a.draw.dims.x,c.y*a.draw.dims.y):a.ctx.lineTo(c.x*a.draw.dims.x,c.y*a.draw.dims.y);l.push(a.ctx.stroke())}return l},e=function(){var b,c,d,e,f,g,h,i;for(b=a.ctx.getImageData(0,0,a.draw.dims.x,a.draw.dims.y),c=function(){var a,c,d,f;for(d=b.data,f=[],a=0,c=d.length;c>a;a+=4)e=d[a],f.push(e);return f}(),g=[],d=h=0,i=c.length;i>h;d=++h)e=c[d],f={id:d},f.type=e>0?"road":"grass",g[d]=f;return console.log(g),a.tiles=g,a.updateworld(g)}}}}])}.call(this),function(){"use strict";angular.module("tilemapApp").controller("GenerateCtrl",["$scope","$resource","angularFire",function(a,b){var c,d,e,f,g,h,i,j,k;return a.position=null,a.nodes={},a.roads=[],a.toDraw={},a.world={},a.hash={n:7,dims:{}},k=function(b){return console.log(b),a.$apply(function(){return a.position=b}),d(),g(function(){return e(),h(),c(a.bbox)})},d=function(){return a.hash.original=GeoHasher.encode(a.position.coords.latitude,a.position.coords.longitude),a.$apply(function(){return a.hash.box=a.hash.original.slice(0,a.hash.n),console.log(a.hash)})},g=function(a){return a()},e=function(){var b,c,d,e,f,g,h;return f=a.hash.n%2===0?0:1,console.log(f),b=(5*a.hash.n-f)/2,c=180/Math.pow(2,b),b=(5*a.hash.n-f-1)/2,h=180/Math.pow(2,b),a.hash.dims.degrees={x:h,y:c},g=a.position.coords.latitude*Math.PI/180,d=111132.92-559.82*Math.cos(2*g)+1.175*Math.cos(4*g),e=111412.84*Math.cos(g)-93.5*Math.cos(3*g),a.hash.dims.meters={x:Math.round(a.hash.dims.degrees.x*e),y:Math.round(a.hash.dims.degrees.y*d)},console.log(a.hash.dims.meters)},h=function(){var b,c,d,e;return c=a.position.coords.latitude,d=a.position.coords.longitude,a.world.center={lat:c,lon:d},e=GeoHasher.decode(a.hash.box),b={clat:e.latitude[1],clon:e.longitude[1],minlat:Math.min.apply(Math,e.latitude),maxlat:Math.max.apply(Math,e.latitude),minlon:Math.min.apply(Math,e.longitude),maxlon:Math.max.apply(Math,e.longitude)},a.bbox=b,console.log(b)},f=function(){return navigator.geolocation.getCurrentPosition(k)},c=function(a){var c,d,e,f,g;return g="http://overpass-api.de/api/interpreter",d=""+a.minlat+","+a.minlon+","+a.maxlat+","+a.maxlon,f="(node("+d+");rel(bn)->.x;way("+d+");node(w)->.x;rel(bw););out body;",console.log(f),c=b(g),e=c.get({data:"[out:json];"+f},j)},j=function(b){var c,d,e,f,g,h,j,k;for(console.log(b),console.groupCollapsed("Ignoring elements"),h=b.elements,f=0,g=h.length;g>f;f++)e=h[f],"node"===e.type?(a.nodes[e.id]=e,console.log(e)):"way"===e.type&&((null!=(j=e.tags)?j.highway:void 0)?a.roads.push(e):console.log("ignoring "+JSON.stringify(e.tags)));console.groupEnd(),k=a.nodes;for(c in k)d=k[c],d=i(d);return a.toDraw={dims:a.hash.dims.meters,nodes:a.nodes,roads:a.roads}},i=function(b){return b.y=(a.bbox.maxlat-b.lat)/a.hash.dims.degrees.y,b.x=(b.lon-a.bbox.minlon)/a.hash.dims.degrees.x},a.updateworld=function(b){return console.log("got update request"),console.log(b),a.world.meta={dims:a.hash.dims.meters,bbox:a.bbox},a.world.tiles=b},f()}])}.call(this),function(){"use strict";angular.module("tilemapApp").controller("ViewCtrl",["$scope","angularFire",function(a){var b,c,d;return a.precision=8,c=function(){return navigator.geolocation.getCurrentPosition(d)},d=function(c){return console.log(c),a.$apply(function(){return a.position=c}),b()},b=function(){var b;return b=GeoHasher.encode(a.position.coords.latitude,a.position.coords.longitude),a.$apply(function(){return a.hash=b.slice(0,a.precision)}),console.log(b)},c()}])}.call(this),function(){"use strict";angular.module("tilemapApp").directive("viewer",["$timeout","angularFire",function(a,b){return{templateUrl:"./views/partials/viewer.html",restrict:"E",scope:{world:"=",hash:"="},link:function(a,c){var d,e,f,g,h;return a.tileSources={},a.tileSources.grass=new Image,a.tileSources.grass.src="http://minecraft-cube.comuv.com/textures/grass-top.png",a.tileSources.road=new Image,a.tileSources.road.src="http://i.imgur.com/eqpOX.png",e=function(){return a.$watch("hash",function(a){return console.log("hash is "+a),a?h(a):void 0}),a.$watch("world",function(a){return a&&a.meta?(f(),d()):void 0})},g=function(){var b,c,d,e,f;for(e=a.tileSources,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.image=new ImageObj);return f},f=function(){var b,d,e;return a.canvas=b=c.find("canvas")[0],a.ctx=d=b.getContext("2d"),b.width=600,b.height=600*a.world.meta.dims.y/a.world.meta.dims.x,d.width=b.width,d.height=b.height,d.strokeStyle="#333333",d.lineWidth=1,e=b.width,a.blockSize=e/a.world.meta.dims.x},d=function(){var b,c,d,e,f,g,h,i;for(console.log("drawing blocks!"),h=a.world.tiles,i=[],b=f=0,g=h.length;g>f;b=++f)c=h[b],d=b%a.world.meta.dims.x*a.blockSize,e=Math.floor(b/a.world.meta.dims.x)*a.blockSize,i.push(a.ctx.drawImage(a.tileSources[c.type],d,e,a.blockSize,a.blockSize));return i},h=function(c){var d,e;return console.log(c),e=new Firebase("https://wander.firebaseio.com/world/"+c),d=b(e,a,"world")},e()}}}])}.call(this),function(){"use strict";var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("tilemapApp").directive("walk",["$timeout","$resource","angularFire",function(b,c,d){return{template:'<canvas id="walkCanvas"></canvas>',restrict:"E",scope:{world:"=",hash:"=",position:"="},link:function(b,e){var f,g,h,i,j,k,l,m,n,o,p,q;return b.precision=8,b.chunks=[],b.camera={x:0,y:0},b.touch={x:.5,y:.5},b.tileSources={},b.tileSources.grass=new Image,b.tileSources.grass.src="http://minecraft-cube.comuv.com/textures/grass-top.png",b.tileSources.road=new Image,b.tileSources.road.src="http://i.imgur.com/eqpOX.png",b.tileSources.building=new Image,b.tileSources.building.src="http://img862.imageshack.us/img862/7013/woodenplanks.png",l=function(){return document.addEventListener("touchmove",function(a){return a.preventDefault()}),b.$watch("position",function(a){return a?(m(),n(),h()):void 0})},m=function(){var a,c,d;return b.canvas=a=e.find("canvas")[0],b.ctx=c=a.getContext("2d"),a.width=window.innerWidth,a.height=window.innerHeight,c.width=a.width,c.height=a.height,c.strokeStyle="#FFFFFF",c.lineWidth=3,d=a.width,b.blockSize=d/40,o()},o=function(){return Hammer(b.canvas).on("touch",q),Hammer(b.canvas).on("drag",q),Hammer(b.canvas).on("release",function(){return b.touch={x:.5,y:.5}})},q=function(a){return a.preventDefault(),b.touch={x:a.gesture.center.pageX/b.ctx.width,y:a.gesture.center.pageY/b.ctx.height}},n=function(){var a,c,d,e,g,h,i;for(a=k(b.position),d=geohash.Neighbours(a),b.hashes=[a],b.hashes=b.hashes.concat(d),console.log(b.hashes),h=b.hashes,i=[],c=e=0,g=h.length;g>e;c=++e)a=h[c],i.push(b.chunks[c]=new f(a,c));return i},p=function(){var a,c,d,e;for(b.chunks[0].loaded&&b.ctx.translate(-b.chunks[0].dims.x/2,-b.chunks[0].dims.y/2),e=b.chunks,c=0,d=e.length;d>c;c++)a=e[c],a.loaded&&a.render();return b.chunks[0].loaded?b.ctx.translate(b.chunks[0].dims.x/2,b.chunks[0].dims.y/2):void 0},k=function(a){var c;return c=GeoHasher.encode(a.coords.latitude,a.coords.longitude),c.slice(0,b.precision)},h=function(){return requestAnimationFrame(h),i()},i=function(){var a,c;return b.camera.x+=10*-(b.touch.x-.5),b.camera.y+=10*-(b.touch.y-.5),b.ctx.clearRect(0,0,b.ctx.width,b.ctx.height),a=b.ctx.width/2+b.camera.x,c=b.ctx.height/2+b.camera.y,b.ctx.translate(a,c),p(),b.ctx.translate(-a,-c),j()},j=function(){return b.ctx.beginPath(),b.ctx.arc(b.ctx.width/2,b.ctx.height/2,5,0,2*Math.PI),b.ctx.stroke()},f=function(){function c(c,d){this.hash=c,this.position=d,this.generate=a(this.generate,this),this.loaded=!1,this.data={},this.ctx=b.ctx,this.offset=this.mapOffset(d),this.initFirebase()}return c.prototype.initFirebase=function(){var a,c,e=this;return c=new Firebase("https://wander.firebaseio.com/world/"+this.hash),a=d(c,b,"chunks["+this.position+"].data"),a.then(function(){return e.data.meta?(e.onload(),console.log("Loaded chunk "+e.hash+"...")):(console.log("Chunk "+e.hash+" does not exist. Generating!"),e.generate())},function(a){return console.error("problem loading!"),console.log(a)},function(){return console.log("got notification!")})},c.prototype.onload=function(){return this.loaded=!0,this.calcDims()},c.prototype.calcDims=function(){return console.log("called for "+this.hash),this.dims={x:b.blockSize*this.data.meta.dims.x,y:b.blockSize*this.data.meta.dims.y}},c.prototype.render=function(){var a,b;return a=this.offset.x*this.dims.x,b=this.offset.y*this.dims.y,this.ctx.translate(a,b),this.renderBlocks(),this.renderBorder(),this.ctx.translate(-a,-b)},c.prototype.renderBorder=function(){return b.ctx.beginPath(),this.ctx.rect(0,0,this.dims.x,this.dims.y),b.ctx.stroke()},c.prototype.renderBlocks=function(){var a,c,d,e,f,g,h,i;for(h=this.data.tiles,i=[],c=f=0,g=h.length;g>f;c=++f)a=h[c],d=c%this.data.meta.dims.x*b.blockSize,e=Math.floor(c/this.data.meta.dims.x)*b.blockSize,i.push(this.ctx.drawImage(b.tileSources[a.type],d,e,b.blockSize,b.blockSize));return i},c.prototype.mapOffset=function(a){switch(a){case 0:return{x:0,y:0};case 8:return{x:-1,y:0};case 1:return{x:-1,y:-1};case 2:return{x:0,y:-1};case 3:return{x:1,y:-1};case 4:return{x:1,y:0};case 5:return{x:1,y:1};case 6:return{x:0,y:1};case 7:return{x:-1,y:1}}},c.prototype.generate=function(){var a=this;return console.log("Generating "+this.hash),this.factory=new g(this.hash,function(b){return a.data=b,a.onload()})},c}(),g=function(){function b(b,c){this.hash=b,this.callback=c,this.parseData=a(this.parseData,this),this.makeBbox(),this.calcDims(),this.canvas=document.createElement("canvas"),this.canvas.id=this.hash,this.ctx=this.canvas.getContext("2d"),this.ctx.width=this.dims.meters.x,this.ctx.height=this.dims.meters.y,console.log(this.dims),document.getElementById("canvasContainer").appendChild(this.canvas),this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=1,this.nodes={},this.ways=[{type:"road",tag:"highway"},{type:"building",tag:"building"}],this.initThings(),this.getData()}return b.prototype.initThings=function(){var a,b,c,d,e,f;for(this.things=[],e=this.ways,f=[],a=c=0,d=e.length;d>c;a=++c)b=e[a],f.push(this.things[a]={type:b.type,vectors:[]});return f},b.prototype.makeBbox=function(){var a;return a=GeoHasher.decode(this.hash),this.center={lat:a.latitude[2],lon:a.longitude[2]},this.bbox={clat:a.latitude[2],clon:a.longitude[2],minlat:a.latitude[0],maxlat:a.latitude[1],minlon:a.longitude[0],maxlon:a.longitude[1]}},b.prototype.calcDims=function(){var a,b,c;return this.dims={meters:{},degrees:{}},this.dims.degrees={x:this.bbox.maxlon-this.bbox.minlon,y:this.bbox.maxlat-this.bbox.minlat},c=this.bbox.clat*Math.PI/180,a=111132.92-559.82*Math.cos(2*c)+1.175*Math.cos(4*c),b=111412.84*Math.cos(c)-93.5*Math.cos(3*c),this.dims.meters={x:Math.round(this.dims.degrees.x*b),y:Math.round(this.dims.degrees.y*a)}},b.prototype.getData=function(){var a,b,d,e,f;return f="http://overpass-api.de/api/interpreter",b=""+this.bbox.minlat+","+this.bbox.minlon+","+this.bbox.maxlat+","+this.bbox.maxlon,e="(node("+b+");rel(bn)->.x;way("+b+");node(w)->.x;rel(bw););out body;",a=c(f),d=a.get({data:"[out:json];"+e},this.parseData)},b.prototype.parseData=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(console.log(a),console.groupCollapsed("Ignoring elements"),l=a.elements,h=0,j=l.length;j>h;h++)if(f=l[h],"node"===f.type)this.nodes[f.id]=f;else if("way"===f.type){for(b=!1,m=this.ways,d=i=0,k=m.length;k>i;d=++i)g=m[d],(null!=(n=f.tags)?n[g.tag]:void 0)&&(this.things[d].vectors.push(f),b=!0);b||console.log("ignoring "+JSON.stringify(f.tags))}console.groupEnd(),console.log(this.things),o=this.nodes;for(c in o)e=o[c],e=this.normalize(e);return this.initTiles(),this.drawCanvas(),this.buildWorld(),console.log("done!"),console.log(this.world)},b.prototype.normalize=function(a){return a.y=(this.bbox.maxlat-a.lat)/this.dims.degrees.y,a.x=(a.lon-this.bbox.minlon)/this.dims.degrees.x},b.prototype.initTiles=function(){var a,b,c,d;for(this.tiles=[],d=[],a=b=0,c=this.dims.meters.x*this.dims.meters.y;c>=0?c>b:b>c;a=c>=0?++b:--b)d.push(this.tiles[a]={id:a,type:"grass"});return d},b.prototype.drawCanvas=function(){var a,b,c,d,e;for(d=this.things,e=[],b=0,c=d.length;c>b;b++)a=d[b],console.log("thing!"),console.log(a),this.clearCanvas(),this.drawVectors(a.vectors),e.push(this.parseCanvas(a.type));return e},b.prototype.clearCanvas=function(){return this.ctx.clearRect(0,0,this.dims.meters.x,this.dims.meters.y)},b.prototype.drawVectors=function(a){var b,c,d,e,f,g,h,i,j,k;for(k=[],f=0,h=a.length;h>f;f++){for(e=a[f],this.ctx.beginPath(),j=e.nodes,b=g=0,i=j.length;i>g;b=++g)d=j[b],c=this.nodes[d],0===b?this.ctx.moveTo(c.x*this.dims.meters.x,c.y*this.dims.meters.y):this.ctx.lineTo(c.x*this.dims.meters.x,c.y*this.dims.meters.y);k.push(this.ctx.stroke())}return k},b.prototype.parseCanvas=function(a){var b,c,d,e,f,g,h,i;for(b=this.ctx.getImageData(0,0,this.dims.meters.x,this.dims.meters.y),c=function(){var a,c,d,f;for(d=b.data,f=[],a=0,c=d.length;c>a;a+=4)e=d[a],f.push(e);return f}(),i=[],d=g=0,h=c.length;h>g;d=++g)e=c[d],e>0?(f={id:d,type:a},i.push(this.tiles[d]=f)):i.push(void 0);return i},b.prototype.buildWorld=function(){return this.world={center:this.center,meta:{dims:this.dims.meters,bbox:this.bbox},tiles:this.tiles},console.log("building world:"),console.log(this.world),this.callback(this.world),this.cleanUp()},b.prototype.cleanUp=function(){return document.getElementById(this.hash).remove()},b}(),l()}}}])}.call(this),function(){"use strict";angular.module("tilemapApp").controller("WalkCtrl",["$scope","angularFire",function(a){var b,c,d;return a.precision=8,c=function(){return navigator.geolocation.getCurrentPosition(d)},d=function(b){return console.log(b),a.$apply(function(){return a.position=b})},b=function(){return console.log("hi!")},c()}])}.call(this);